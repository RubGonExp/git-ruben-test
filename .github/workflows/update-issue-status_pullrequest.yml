name: Merge Comment

on:
  pull_request:
    types: [synchronize]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
jobs:
  merge-comment:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Get Issue URLs
        id: get-issue-urls
        env:
            body_text: ${{ github.event.pull_request.body }}
        run: |
          urls=$(echo "$body_text" | grep -oP '(?<=\().*?(?=\))')
          echo "urls=$(echo "$urls" | sed 's#https://github.com/#https://api.github.com/repos/#')" >> $GITHUB_ENV
      - name: Add comment to issues
        env:
          api_urls: ${{ env.urls }}
        run: |
          echo "api_urls: $api_urls"
          for url in $api_urls; do
            issue_number=$(echo "$url" | grep -oP '(?<=/issues/)\d+')
            comment_body="Este es un comentario de ejemplo para el issue #${issue_number}"
            curl -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -d "{\"body\":\"$comment_body\"}" "$url/comments"
          done
      - name: Add label to issues
        env:
          label: "In review"
          api_urls: ${{ env.urls }}
        run: |
          for url in $api_urls; do
            curl -X POST -H "Authorization: Bearer $GITHUB_TOKEN" -d "{\"labels\":[\"$label\"]}" "$url/labels"
          done
